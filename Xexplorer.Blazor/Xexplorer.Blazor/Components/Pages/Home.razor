@page "/"
@using Xexplorer.Blazor.Utils
@using Xexplorer.Blazor.ViewModels.Pages
@inject HomeViewModel homeVM

<div class="video-row" id="main-container">
    <Virtualize Items="@homeVM.Videos" ItemSize="460" Context="video">
        <MudPaper Elevation="1" Class="pa-4 video-row-border">
            <MudGrid>
                <MudItem xs="12">
                    <MudPaper Elevation="1">
                        <MudInputLabel xs="12" class="video-title">@video.VideoDir</MudInputLabel>
                        <MudDivider Class="video-divider"/>
                        <MudStack Row="true" Spacing="2" Class="title-strip">
                            <MudTooltip Text="@video.Caption">
                                <MudInputLabel class="video-title"
                                               Style="@($"color:{homeVM.GetColor(video.CaptionColor)}")">@video.Caption</MudInputLabel>
                            </MudTooltip>
                        </MudStack>
                        <MudDivider Class="video-divider"/>
                        <MudStack Row="true" Spacing="2" Class="title-strip">
                            <MudRating SelectedValue="@video.Evaluate" Style="padding-left: 10px"
                                       SelectedValueChanged="@(newValue => homeVM.SetEvaluateAsync(video, newValue))"
                                       Size="Size.Large"/>
                            <MudSpacer/>
                            <MudInputLabel class="video-title">@video.Minute 分钟</MudInputLabel>
                            <MudInputLabel class="video-title">==</MudInputLabel>
                            <MudInputLabel class="video-title">@video.Length MB</MudInputLabel>
                            <MudInputLabel class="video-title">==</MudInputLabel>
                            <MudInputLabel class="video-title">@video.Width x @video.Height</MudInputLabel>
                            <MudInputLabel class="video-title">==</MudInputLabel>
                            <MudInputLabel class="video-title">@video.ModifyTime?.ToString("yyyy-MM-dd")</MudInputLabel>
                        </MudStack>
                    </MudPaper>
                </MudItem>
                <MudItem xs="12">
                    <MudPaper xs="12" Class="d-flex align-content-start flex-wrap flex-grow-1 gap-4" Height="auto"
                              Elevation="0">
                        <MudStack Row="true" Spacing="2" Class="image-strip">
                            <div style="flex: 1 1 auto; min-width: 77px; max-width: 77px; padding-left: 5px">
                                <MudPaper Elevation="4">
                                    <MudButtonGroup Color="Color.Primary" Variant="Variant.Filled"
                                                    Vertical="true">
                                        <MudBadge Content="@video.PlayCount.ToString()" Color="Color.Error"
                                                  Overlap="true">
                                            <MudButton OnClick="() => homeVM.PlayAsync(video)">播放</MudButton>
                                        </MudBadge>
                                        <MudButton OnClick="()=>homeVM.AddPlayListAsync(video)">加入</MudButton>
                                        <MudButton OnClick="()=>homeVM.OpenFolder(video)">目录</MudButton>
                                        <MudButton OnClick="()=>homeVM.DeleteVideoAsync(video)">删除</MudButton>
                                        <MudButton OnClick="()=>homeVM.ResetVideoAsync(video)">重置</MudButton>
                                    </MudButtonGroup>
                                </MudPaper>
                            </div>
                            @foreach (var img in video.Images)
                            {
                                <div style="flex: 1 1 auto; min-width: 0;">
                                    <MudPaper Elevation="4">
                                        <MudImage
                                            Src="@($"{AppsettingsUtils.Default.Api.BaseUrl}/{AppsettingsUtils.Default.Api.GetImageApi}?name={img.Path}")"
                                            Class="image-item" ObjectPosition="ObjectPosition.Center"
                                            ObjectFit="ObjectFit.Cover"
                                            @onclick="() => homeVM.ShowCarouselAsync(video)"></MudImage>
                                    </MudPaper>
                                </div>
                            }
                        </MudStack>
                    </MudPaper>
                </MudItem>
            </MudGrid>
        </MudPaper>
    </Virtualize>
</div>

@code {

    protected override void OnInitialized()
    {
        base.OnInitialized();
        homeVM.OnChange += StateHasChanged;
    }

}

<style>
    .video-divider {
        border-top: 2px dotted #999;
        margin-bottom: 1px;
        margin-top: 1px;
        margin-left: 10px;
        margin-right: 10px;
    }

    .video-row-border {
        border: 1px solid #999;
        height: 460px; /* 固定高度 */
        overflow: hidden;
    }

    .video-row {
        height: 92vh;
        overflow-y: auto;
        padding-left: 10px;
    }
 
    .video-title {
        font-family: 'AlimamaThin';
        font-weight: normal;
        font-size: 20px;
        padding-bottom: 3px;
        padding-top: 3px;
        padding-left: 10px;
    }

    .title-strip {
        width: 100%;
        overflow: visible;
        display: flex;
        align-items: center;
    }

    .image-strip {
        width: 100%;
        overflow: visible;
        display: flex;
    }

    /* 针对 MudStack 的内部样式优化 */
    .image-strip .mud-stack {
        display: inline-flex; /* 配合父级的 nowrap */
        flex-wrap: nowrap; /* 禁止 MudStack 换行 */
    }

    .image-item {
        display: block;
        width: 100%;
        height: 300px;
        max-height: 300px;
        border: 2px solid #ccc;
        border-radius: 8px;
        transition: transform 0.3s ease, box-shadow 0.2s ease;
    }

    .image-item:hover {
        transform: scale(1.1) translateY(1px);
        transform-origin: center top;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        border-color: #ccc;
        background-color: #222;
        position: relative;
        z-index: 999;
    }

    /* 可选：美化滚动条 (仅限 Webkit 浏览器) */
    .image-strip::-webkit-scrollbar {
        height: 6px;
    }

    .image-strip::-webkit-scrollbar-thumb {
        background-color: #ccc;
        border-radius: 10px;
    }
</style>
